
#include <stdio.h>
#include <stdlib.h>
#include <memory.h>

#include "CodeMeter.h"

void xDump(unsigned char *data, int l)
{
    int i;
    for(i = 0; i < l; i++)
    {
        printf("%02.2X", data[i]);
        if(i < l - 1)
            if((i & 15) != 15)
                printf(", ");
            else
                printf("\n");
        else
            printf("\n");
    }
}

void ErrorHandler(char *line, int ExitCode, HCMSysEntry hcmEntry)
{
    char acErrText[256];
    switch(CmGetLastErrorCode())
    {
        case CMERROR_NO_ERROR:
            return;
        case CMERROR_KEYSOURCEWRONG:
            fprintf(stderr, "%s: The specified key is invalid (e.g. wrong length).\n", line);
            break;
        default:
            CmGetLastErrorText(CM_GLET_ERRORTEXT, acErrText, sizeof(acErrText));
            fprintf(stderr, "%s: Other error occurred: \"%s\"\n", line, acErrText);
            break;
    }

    /* Despite the error try to close the handle. */
    if (NULL != hcmEntry)
      CmRelease(hcmEntry);
    exit(ExitCode);
}

int main(void)
{
    CMULONG res;
    CMULONG cbPublicKey = CM_PUBLIC_KEY_LEN;

    unsigned char abPublicKey[] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

    /* Note: the buffer has to be lager (CM_PUBLIC_KEY_LEN) */
    /* than the actual data */
    CMULONG cbData;
    printf("Enter the data size: ");
    scanf("%d", &cbData);
     
    unsigned char abData[] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

    res = CmCryptEcies(abPublicKey, cbPublicKey, abData, cbData + CM_PUBLIC_KEY_LEN); 
    if(0 == res){
      ErrorHandler("CmCryptEcies", 1, NULL);
    }
    printf("Encrypted data:\n");
    xDump(abData, res);

    return 0;
}
